{% extends 'base.html' %}

{% block title %}ê¸°ìƒ ë° ìˆ˜ìœ„ ì •ë³´ - ì‹œí™”ì¡°ë ¥ ìŠ¤ë§ˆíŠ¸ ê´€ì œ{% endblock %}

{% block style %}
    /* 1. ìƒë‹¨ ìƒíƒœ ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
    .status-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 25px;
        margin-bottom: 40px;
    }
    .status-card {
        background: #ffffff;
        padding: 25px;
        border-radius: 12px;
        border: 2px solid #e5e5e5;
        text-align: center;
    }
    .status-label { font-size: 1.1em; color: #666; font-weight: 700; margin-bottom: 10px; }
    .status-value { font-size: 2em; font-weight: 800; color: #0056b3; }
    .status-unit { font-size: 0.6em; color: #888; margin-left: 5px; }

    /* 2. ë©”ì¸ ë¶„ì„ ë ˆì´ì•„ì›ƒ (ì¢Œ: ê¸°ìƒ / ìš°: ìœ„í—˜ë„) */
    .weather-layout { 
        display: grid; 
        grid-template-columns: 1.2fr 1fr; 
        gap: 30px; 
        margin-bottom: 40px; /* ê·¸ë˜í”„ ì„¹ì…˜ê³¼ì˜ ê°„ê²© */
    }
    .weather-card { 
        background: #ffffff; 
        padding: 35px; 
        border-radius: 12px; 
        border: 2px solid #e5e5e5; 
    }
    .weather-card h2 { 
        color: #0056b3; 
        margin-top: 0; 
        border-bottom: 2px solid #0056b3; 
        padding-bottom: 15px;
        font-size: 1.5em;
    }

    /* 3. ìœ„í—˜ë„ ì¸ë””ì¼€ì´í„° */
    .risk-indicator { 
        padding: 25px; 
        border-radius: 10px; 
        text-align: center; 
        font-size: 1.3em; 
        font-weight: 800; 
        margin-top: 20px;
    }
    .risk-low { background: #e7f5ff; color: #0056b3; border: 2px solid #b3d7ff; }
    .risk-high { 
        background: #fff5f5; color: #e03131; border: 2px solid #ffc9c9; 
        animation: flash 1.5s infinite; 
    }
    @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

    /* ë°ì´í„° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .data-row {
        display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; font-size: 1.1em;
    }
    .data-label { color: #555; font-weight: 600; }
    .data-val { font-weight: 800; color: #222; }

    /* ê·¸ë˜í”„ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .chart-container {
        background: #ffffff;
        padding: 40px;
        border-radius: 12px;
        border: 2px solid #e5e5e5;
        margin-bottom: 40px;
    }
    .chart-container h3 {
        color: #0056b3;
        margin-top: 0;
        border-bottom: 2px solid #0056b3;
        padding-bottom: 15px;
        font-size: 1.5em;
        margin-bottom: 30px;
    }
    .chart-canvas {
        width: 100%;
        max-height: 400px; /* ê·¸ë˜í”„ ë†’ì´ ì œí•œ */
    }
{% endblock %}

{% block content %}
    <h1 style="margin-bottom: 30px; font-weight: 800; color: #222;">ì‹¤ì‹œê°„ ê¸°ìƒ ë° ìˆ˜ìœ„ ê´€ì œ</h1>
    
    <div class="status-grid">
        <div class="status-card">
            <div class="status-label">ì™¸í•´ ìˆ˜ìœ„ (Tide)</div>
            <div class="status-value">
                <span id="curr-sea">{{ arduino.sea }}</span><span class="status-unit">m</span>
            </div>
        </div>
        <div class="status-card">
            <div class="status-label">ë‚´í•´ ìˆ˜ìœ„ (Lake)</div>
            <div class="status-value">
                <span id="curr-lake">{{ arduino.lake }}</span><span class="status-unit">m</span>
            </div>
        </div>
        <div class="status-card" style="border-color: #0056b3; background: #f0f7ff;">
            <div class="status-label" style="color:#0056b3;">í˜„ì¬ ë°œì „ ë‚™ì°¨</div>
            <div class="status-value" style="color:#0056b3;">
                <span id="curr-head">{{ arduino.head }}</span><span class="status-unit">m</span>
            </div>
        </div>
    </div>

    <div class="weather-layout">
        <div class="weather-card">
            <h2>ê¶Œì—­ë³„ í‰ê·  ê¸°ìƒ í˜„í™©</h2>
            <div class="desc-box" style="margin-bottom: 20px;">
                ì•ˆì–‘, í™”ì„±, ì¸ì²œ ë“± ì‹œí™”í˜¸ ìœ ì… í•˜ì²œ ì¸ê·¼ <strong>6ê°œ ì£¼ìš” ì§€ì </strong>ì˜ ê¸°ìƒ ë°ì´í„°ë¥¼ í‰ê· í•˜ì—¬ ì‚°ì¶œí•œ ì§€í‘œì…ë‹ˆë‹¤.
            </div>
            
            <div class="data-row">
                <span class="data-label">í‰ê·  ê¸°ì˜¨</span>
                <span class="data-val">14.2Â°C</span>
            </div>
            <div class="data-row">
                <span class="data-label">6ê°œ ì§€ì  í‰ê·  ê°•ìˆ˜ëŸ‰ (24h)</span>
                <span class="data-val" style="color: #0056b3;">45.5 mm</span>
            </div>
            <div class="data-row">
                <span class="data-label">ê¶Œì—­ í‰ê·  í’ì†</span>
                <span class="data-val">3.8 m/s</span>
            </div>
            
            <p style="font-size: 0.9em; color: #888; margin-top: 15px;">
                * ë°ì´í„° ê°±ì‹ : ì‹¤ì‹œê°„ API ì—°ë™ ì¤‘
            </p>
        </div>

        <div class="weather-card">
            <h2>ì“°ë ˆê¸° ìœ ì… ìœ„í—˜ë„ ë¶„ì„</h2>
            <p style="color: #666; font-size: 1em; font-weight: 500;">
                ê°•ìˆ˜ëŸ‰ íŒ¨í„´ê³¼ ê³¼ê±° ìˆ˜ê±°ëŸ‰ ë°ì´í„°ì˜ ìƒê´€ê´€ê³„ë¥¼ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.
            </p>
            
            <div id="risk-box" class="risk-high">
                âš ï¸ ìœ„í—˜: ë¶€ìœ ë¬¼ ìœ ì… ê¸‰ì¦ ë‹¨ê³„
            </div>
            
            <div style="margin-top: 25px; line-height: 1.8; color: #444; font-size: 1.05em;">
                í˜„ì¬ 6ê°œ ì§€ì  í‰ê·  ê°•ìˆ˜ëŸ‰ì´ <span style="color: #e03131; font-weight: 800;">45.5mm</span>ë¥¼ ê¸°ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤. 
                <br>ë¶„ì„ ê²°ê³¼, ëˆ„ì  ê°•ìˆ˜ëŸ‰ 40mm ì´ˆê³¼ ì‹œ ì‹œí™”ì²œ ë° ìœ ì… í•˜ì²œì˜ ë¶€ìœ  ì“°ë ˆê¸° ìœ í†µëŸ‰ì´ í‰ì‹œ ëŒ€ë¹„ <strong>3ë°° ì´ìƒ ê¸‰ì¦</strong>í•˜ëŠ” íŒ¨í„´ì„ ë³´ì…ë‹ˆë‹¤.
                
                <div style="margin-top: 20px; padding: 15px; background: #fff9db; border-radius: 8px; border: 1px solid #fab005; color: #856404;">
                    <strong>ğŸ“¢ ê´€ì œ ì§€ì¹¨:</strong> ìˆ˜ì°¨ ìœ ì…êµ¬ íì‡„ ìœ„í—˜ì´ ìˆìœ¼ë‹ˆ [ë°œì „ ì‹œë®¬ë ˆì´ì…˜] ë©”ë‰´ì—ì„œ ìœ ëŸ‰ ê°ì†Œì— ë”°ë¥¸ íš¨ìœ¨ ì €í•˜ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.
                </div>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <h3>í•´ìˆ˜ìœ„ & í˜¸ìˆ˜ìœ„ ë³€í™” ì¶”ì´ (API ë°ì´í„°)</h3>
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
            <label style="font-weight:700; color:#444;">ë‚ ì§œ ì„ íƒ</label>
            <input type="date" id="targetDate" />

            <span id="liveBadge"
                style="padding:5px 12px;
                        background:#e7f5ff;
                        color:#0056b3;
                        font-weight:700;
                        border-radius:20px;
                        font-size:0.9em;">
                â— ì‹¤ì‹œê°„
            </span>
        </div>

        <canvas id="tideLakeChart" class="chart-canvas"></canvas>
    </div>

    <div class="chart-container">
        <h3>ê¶Œì—­ë³„ í‰ê·  ê°•ìˆ˜ëŸ‰ (24ì‹œê°„)</h3>
        <canvas id="rainfallChart" class="chart-canvas"></canvas>
    </div>
{% endblock %}

{% block footer %}
    <div class="footer-left">
        <h4 style="color: #495057; font-weight: 800; margin: 0 0 10px 0;">ê¸°ìƒì²­ ë° K-water ë°ì´í„° ì—°ë™</h4>
        <div style="margin: 5px 0; font-weight: 500;">ë³¸ í˜ì´ì§€ì˜ ì •ë³´ëŠ” ê³µê³µë°ì´í„°í¬í„¸ ì‹¤ì‹œê°„ API ë° ëª¨í˜• ì‹¤í—˜ ì„¼ì„œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.</div>
        <div style="margin: 5px 0;">
            ë°ì´í„° ì¶œì²˜ : <a href="https://www.weather.go.kr" target="_blank" class="source-link">ê¸°ìƒì²­ ë‚ ì”¨ëˆ„ë¦¬ â†—</a> | 
            <a href="http://www.kwater.or.kr" target="_blank" class="source-link">K-water ë¬¼ì •ë³´í¬í„¸ â†—</a>
        </div>
    </div>

    <div class="footer-right" style="text-align: right;">
        <div style="font-weight: 700; margin-bottom: 5px; color: #495057;">2026 ì¬ìƒì—ë„ˆì§€ ë°ì´í„° ë¶„ì„ í”„ë¡œì íŠ¸</div>
        <div class="presenter-name" style="padding: 5px 15px;">ë°œí‘œì : ì„œì£¼ì—°</div>
    </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let tideChart; 
    const dateInput = document.getElementById('targetDate');
    const liveBadge = document.getElementById('liveBadge');
    
    // 1. ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„¤ì •
    const today = new Date().toLocaleDateString('sv-SE'); 
    dateInput.value = today;

    // 2. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ (ê¸°ì¡´ Jinja2 ë³€ìˆ˜ ëŒ€ì‹  fetch ì‚¬ìš©)
    function loadData(selectedDate) {
        const url = (selectedDate === today) ? '/api/realtime' : `/api/history/${selectedDate}`;
        
        fetch(url).then(res => res.json()).then(data => {
            if(data.error) { alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
            drawChart(data);
        });
    }

    // 3. ê·¸ë˜í”„ ê·¸ë¦¬ê¸° (30ë¶„ ë‹¨ìœ„ ëˆˆê¸ˆ ì„¤ì • í¬í•¨)
    function drawChart(data) {
        const ctx = document.getElementById('tideLakeChart').getContext('2d');
        if (tideChart) tideChart.destroy(); // ê¸°ì¡´ ê·¸ë˜í”„ ì§€ìš°ê¸°

        tideChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.times,
                datasets: [
                    { label: 'ì™¸í•´ìˆ˜ìœ„', data: data.sea, borderColor: '#0056b3', fill: false, pointRadius: 0 },
                    { label: 'ë‚´í•´ìˆ˜ìœ„', data: data.lake, borderColor: '#42a5f5', fill: false, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            // 30ë¶„ ë‹¨ìœ„ë¡œë§Œ ê¸€ì í‘œì‹œ
                            callback: function(val, index) {
                                const time = this.getLabelForValue(val);
                                return (time.includes(':00') || time.includes(':30')) ? time : '';
                            },
                            autoSkip: false
                        }
                    }
                }
            }
        });
    }

    // 4. ë‚ ì§œ ë³€ê²½ ì‹œ ì‘ë™
    dateInput.addEventListener('change', function(e) {
        if (e.target.value === today) {
            location.reload(); 
        } else {
            liveBadge.style.display = 'none';
            loadData(e.target.value);
        }
    });

    // 5. ì•„ë‘ì´ë…¸ ìˆ«ì ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (1ì´ˆë§ˆë‹¤)
    setInterval(() => {
        if (dateInput.value !== today) return; 
        fetch('/data').then(res => res.json()).then(data => {
            document.getElementById('curr-sea').innerText = data.sea.toFixed(2);
            document.getElementById('curr-lake').innerText = data.lake.toFixed(2);
            document.getElementById('curr-head').innerText = data.head.toFixed(2);
        });
    }, 1000);

    // 6. 30ë¶„ ìë™ ìƒˆë¡œê³ ì¹¨ (API íŠ¸ë˜í”½ ë³´í˜¸)
    setTimeout(() => { if (dateInput.value === today) location.reload(); }, 1800000);

    // ì´ˆê¸° ì‹¤í–‰
    loadData(today);
</script>
{% endblock %}